/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package proyecto.pkg1.edd;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.filechooser.FileNameExtensionFilter;
import proyecto.pkg1.edd.Grafo; 
import java.io.BufferedWriter;
import java.io.FileWriter; 



/**
 *
 * @author a-utr
 */
public class Interfaz extends javax.swing.JFrame {
    private ArrayList<String> listaUsuarios = new ArrayList<>();
    private ArrayList<String> listaRelaciones = new ArrayList<>();
    private Grafo miGrafo;

    /**
     * Creates new form Interfaz
     */
    public Interfaz() {
        initComponents();
         this.miGrafo = new Grafo (true,100); // Inicializacion del grafo
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel2 = new javax.swing.JPanel();
        jPanel1 = new javax.swing.JPanel();
        jTextField1 = new javax.swing.JTextField();
        jLabel2 = new javax.swing.JLabel();
        botoncargararchivo = new javax.swing.JButton();
        jLabel1 = new javax.swing.JLabel();
        jButton1 = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        txtContenido = new javax.swing.JTextArea();
        jLabel3 = new javax.swing.JLabel();
        jSeparator1 = new javax.swing.JSeparator();
        jButton2 = new javax.swing.JButton();
        txtNuevoUsuario = new javax.swing.JTextField();

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setBackground(new java.awt.Color(215, 235, 255));
        getContentPane().setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jPanel2.setBackground(new java.awt.Color(0, 0, 102));
        jPanel2.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jPanel1.setBackground(new java.awt.Color(227, 240, 255));
        jPanel1.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jTextField1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jTextField1ActionPerformed(evt);
            }
        });
        jPanel1.add(jTextField1, new org.netbeans.lib.awtextra.AbsoluteConstraints(50, 130, 390, 30));

        jLabel2.setText("锔");
        jPanel1.add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(320, 70, 30, 30));

        botoncargararchivo.setFont(new java.awt.Font("Segoe UI Emoji", 1, 12)); // NOI18N
        botoncargararchivo.setText("Cargar Archivo ");
        botoncargararchivo.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                botoncargararchivoActionPerformed(evt);
            }
        });
        jPanel1.add(botoncargararchivo, new org.netbeans.lib.awtextra.AbsoluteConstraints(340, 70, -1, 30));

        jLabel1.setFont(new java.awt.Font("Century Gothic", 1, 24)); // NOI18N
        jLabel1.setText("隆Bienvenido! ");
        jPanel1.add(jLabel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(190, 10, -1, -1));

        jButton1.setFont(new java.awt.Font("Century Gothic", 1, 14)); // NOI18N
        jButton1.setText("Continuar");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });
        jPanel1.add(jButton1, new org.netbeans.lib.awtextra.AbsoluteConstraints(380, 450, -1, 30));

        txtContenido.setColumns(20);
        txtContenido.setRows(5);
        jScrollPane1.setViewportView(txtContenido);

        jPanel1.add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(50, 180, 390, 200));

        jLabel3.setFont(new java.awt.Font("Century Gothic", 0, 12)); // NOI18N
        jLabel3.setText("Para iniciar agregue el archivo que desea analizar  ");
        jPanel1.add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(20, 70, -1, 30));

        jSeparator1.setBackground(new java.awt.Color(0, 0, 102));
        jSeparator1.setForeground(new java.awt.Color(0, 0, 102));
        jPanel1.add(jSeparator1, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 50, 480, 10));

        jButton2.setFont(new java.awt.Font("Segoe UI Emoji", 1, 12)); // NOI18N
        jButton2.setText(" Agregar Usuario");
        jButton2.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton2ActionPerformed(evt);
            }
        });
        jPanel1.add(jButton2, new org.netbeans.lib.awtextra.AbsoluteConstraints(50, 450, 160, -1));

        txtNuevoUsuario.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtNuevoUsuarioActionPerformed(evt);
            }
        });
        jPanel1.add(txtNuevoUsuario, new org.netbeans.lib.awtextra.AbsoluteConstraints(60, 410, 150, -1));

        jPanel2.add(jPanel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 20, 500, 500));

        getContentPane().add(jPanel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 560, 550));

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jTextField1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jTextField1ActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_jTextField1ActionPerformed
/**
     * Boton "Cargar Archivo"
     * Abre un JFileChooser para seleccionar un archivo de texto
     * Lee el archivo l铆nea por l铆nea y clasifica el contenido.
     * Actualiza el JTextArea y txtContenido con el texto formateado
     * @param evt Evento de accion que activa este metodo
     */
    private void botoncargararchivoActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_botoncargararchivoActionPerformed
JFileChooser chooser = new JFileChooser();
    FileNameExtensionFilter filter = new FileNameExtensionFilter("Archivos de Texto(.txt)", "txt");
    chooser.setFileFilter(filter);
    chooser.setAcceptAllFileFilterUsed(false);
    chooser.showOpenDialog(null);
    File f = chooser.getSelectedFile();

    if (f != null) {
        String filename = f.getAbsolutePath();
        jTextField1.setText(filename); 

        try (BufferedReader reader = new BufferedReader(new FileReader(f))) {
 
            this.listaUsuarios.clear();
            this.listaRelaciones.clear();
            this.miGrafo = new Grafo(true, 100);

            String modo = "ninguno";
            String linea;
            StringBuilder contenidoParaMostrar = new StringBuilder(); // Para el JTextArea

            while ((linea = reader.readLine()) != null) {

                String lineaLimpia = linea.trim().toLowerCase(); 
                if (lineaLimpia.isEmpty()) {
                    continue; 
                }

                if (lineaLimpia.contains("usuario") || lineaLimpia.contains("user")) { 
                    modo = "usuarios";
                    contenidoParaMostrar.append("--- USUARIOS ---\n");
                    continue; 
                } else if (lineaLimpia.contains("relacion") || lineaLimpia.contains("relation")) {
                    modo = "relaciones";
                    contenidoParaMostrar.append("\n--- RELACIONES ---\n");
                    continue;
                }

                String dato = linea.trim();
                
                if (modo.equals("usuarios")) {
                    this.listaUsuarios.add(dato);
                    contenidoParaMostrar.append(dato).append("\n");
                    
                } else if (modo.equals("relaciones")) {
                    this.listaRelaciones.add(dato);
                    contenidoParaMostrar.append(dato).append("\n");
                }
            }

            txtContenido.setText(contenidoParaMostrar.toString());

            String[] usuariosArray = this.listaUsuarios.toArray(new String[0]);
            String[] relacionesArray = this.listaRelaciones.toArray(new String[0]);
            
            this.miGrafo.cargarDesdeArchivo(usuariosArray, relacionesArray);
            System.out.println("Grafo listo para ser mostrado.");


        } catch (IOException e) {
            JOptionPane.showMessageDialog(this, "Error al leer el archivo: " + e.getMessage(), "Error", JOptionPane.ERROR_MESSAGE);

            txtContenido.setText(""); 
            jTextField1.setText("");
            this.listaUsuarios.clear();
            this.listaRelaciones.clear();
        }
      }

    }//GEN-LAST:event_botoncargararchivoActionPerformed
/**
     * Gestiona el bot贸n "Continuar"
     * Verifica si se ha cargado un archivo comprobando el contenido
     * Si ya existe un archivo, muestra un di谩logo de confirmaci贸n
     * Se pasa la instancia actual al constructor de para permitir la funcionalidad de "Volver"
     * Oculta esta ventana actual para preservar el estado de los datos cargados.
     * @param evt Evento de accion generado por el boton
     */
    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed

    String rutaArchivo = jTextField1.getText();
    if (rutaArchivo.trim().isEmpty()) {
        JOptionPane.showMessageDialog(
            this,
            "Por favor, cargue un archivo antes de continuar.",
            "Error: No hay archivo",
            JOptionPane.ERROR_MESSAGE
        );
        return;
    }

    int resultado = JOptionPane.showConfirmDialog(
        this,
        "El archivo ha sido guardado exitosamente. 驴Desea continuar?",
        "Guardado",
        JOptionPane.OK_CANCEL_OPTION,
        JOptionPane.INFORMATION_MESSAGE
    );

    if (resultado == JOptionPane.OK_OPTION) {

            Interfaz2 siguientePagina = new Interfaz2(this, this.miGrafo, this.listaUsuarios, this.listaRelaciones, rutaArchivo);

            siguientePagina.setVisible(true);
            this.setVisible(false);
        }

    }//GEN-LAST:event_jButton1ActionPerformed
/**
     * Maneja el bot贸n "Agregar Usuario"
     * * @param evt El evento de clic que dispar贸 esta acci贸n.
     */
    private void jButton2ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton2ActionPerformed
        String nuevoUsuario = txtNuevoUsuario.getText().trim();
        String rutaArchivo = jTextField1.getText(); // Obtenemos la ruta

        if (nuevoUsuario.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Por favor, ingrese un nombre de usuario.", "Error", JOptionPane.ERROR_MESSAGE);
            return;
        }

        String nuevoUsuarioConArroba;
        if (nuevoUsuario.startsWith("@")) {
            nuevoUsuarioConArroba = nuevoUsuario;
        } else {
            nuevoUsuarioConArroba = "@" + nuevoUsuario;
        }
   
   
        if (this.listaUsuarios.contains(nuevoUsuarioConArroba)) {
            JOptionPane.showMessageDialog(this, "El usuario '" + nuevoUsuarioConArroba + "' ya existe.", "Usuario duplicado", JOptionPane.WARNING_MESSAGE);
            txtNuevoUsuario.setText("");
            return;
        }

        this.listaUsuarios.add(nuevoUsuarioConArroba);

        this.miGrafo.insertarVertice(nuevoUsuarioConArroba);

        try (BufferedWriter writer = new BufferedWriter(new FileWriter(rutaArchivo))) {

            writer.write("usuarios");
            writer.newLine();
            for (String usuario : this.listaUsuarios) {
                writer.write(usuario);
                writer.newLine();
            }

            writer.newLine();
            writer.write("relaciones");
            writer.newLine();
            for (String relacion : this.listaRelaciones) {
                writer.write(relacion);
                writer.newLine();
            }

        } catch (IOException e) {
            JOptionPane.showMessageDialog(this, "Error al re-escribir el archivo: " + e.getMessage(), "Error de Archivo", JOptionPane.ERROR_MESSAGE);
            this.listaUsuarios.remove(nuevoUsuarioConArroba);
            this.miGrafo.eliminarVertice(nuevoUsuarioConArroba);
            return; // Detiene la ejecuci贸n
        }

        txtNuevoUsuario.setText("");
        actualizarTextAreaVisual();

        System.out.println("Usuario agregado y archivo re-escrito: " + nuevoUsuarioConArroba);
    }//GEN-LAST:event_jButton2ActionPerformed

    private void txtNuevoUsuarioActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtNuevoUsuarioActionPerformed
        // TODO add your handling code here:
    }//GEN-LAST:event_txtNuevoUsuarioActionPerformed
/**
     * Actualiza el contenido del 谩rea de texto 'txtContenido' en la interfaz.
     * * Construye un String que muestra todos los elementos de 'listaUsuarios'
     * y 'listaRelaciones', separados por encabezados, y luego
     * asigna ese String al 'txtContenido'.
     */
    public void actualizarTextAreaVisual() {
        StringBuilder contenido = new StringBuilder();

        contenido.append("--- USUARIOS ---\n");
        for (String u : this.listaUsuarios) {
            contenido.append(u).append("\n");
        }

        contenido.append("\n--- RELACIONES ---\n");
        for (String r : this.listaRelaciones) {
            contenido.append(r).append("\n");
        }
        txtContenido.setText(contenido.toString());
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton botoncargararchivo;
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JSeparator jSeparator1;
    private javax.swing.JTextField jTextField1;
    private javax.swing.JTextArea txtContenido;
    private javax.swing.JTextField txtNuevoUsuario;
    // End of variables declaration//GEN-END:variables
}
